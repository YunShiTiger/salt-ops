edx:
  {% set num_subnets = subnetids|length %}
  {% for app_type, num_instances in app_types.items() %}
  {% for id_num in range(num_instances) %}
  - edx-{{ environment_name }}-{{ app_type }}-{{ id_num }}:
      network_interfaces:
        - DeviceIndex: 0
          AssociatePublicIpAddress: True
          SubnetId: {{ subnetids[id_num % num_subnets] }}
          SecurityGroupId: {{ securitygroupid }}
      tag:
        business_unit: {{ business_unit }}
        environment: {{ environment_name }}
        purpose: {{ purpose }}
      grains:
        business_unit: {{ business_unit }}
        environment: {{ environment_name }}
        {% if app_type not in purpose %}
        {% set purpose = purpose[:-len(purpose.split('-')[-1])] +app_type %}
        purpose:
          - {{ purpose }}
        {% endif %}
        roles:
          - edx
          - edx-{{ app_type }}
{% endfor %}
{% endfor %}
