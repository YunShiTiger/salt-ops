{% set ISO8601 = '%Y-%m-%dT%H:%M:%S' %}

edx:
  {% set num_subnets = subnetids|length %}
  {% for app_type, num_instances in app_types.items() %}
  {% for id_num in range(num_instances.edx) %}
  - edx-{{ environment_name }}-{{ purpose_prefix }}-{{ app_type }}-{{ id_num }}:
      network_interfaces:
        - DeviceIndex: 0
          AssociatePublicIpAddress: True
          SubnetId: {{ subnetids[id_num % num_subnets] }}
          SecurityGroupId:
            - {{ securitygroupids.edxapp }}
            - {{ securitygroupids.default }}
            - {{ securitygroupids['salt-master'] }}
            - {{ securitygroupids['consul-agent'] }}
      image: {{ ami_id }}
      tag:
        business_unit: {{ business_unit }}
        environment: {{ environment_name }}
        purpose_prefix: {{ purpose_prefix }}
        created_at: "{{ salt.status.time(format=ISO8601) }}"
      grains:
        created_at: "{{ salt.status.time(format=ISO8601) }}"
        business_unit: {{ business_unit }}
        environment: {{ environment_name }}
        {% set modified_purpose = purpose_prefix + '-' + app_type %}
        purpose: {{ modified_purpose }}
        roles:
          - edx
          - edx-{{ app_type }}
{% endfor %}
{% endfor %}

edx-worker:
  {% set num_subnets = subnetids|length %}
  {% for app_type, num_instances in app_types.items() %}
  {% for id_num in range(num_instances['edx-worker']) %}
  - edx-worker-{{ environment_name }}-{{ purpose_prefix }}-{{ app_type }}-{{ id_num }}:
        network_interfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: True
            SubnetId: {{ subnetids[id_num % num_subnets] }}
            SecurityGroupId:
              - {{ securitygroupids['edx-worker'] }}
              - {{ securitygroupids.default }}
              - {{ securitygroupids['salt-master'] }}
              - {{ securitygroupids['consul-agent'] }}
        image: {{ ami_id }}
        tag:
          created_at: "{{ salt.status.time(format=ISO8601) }}"
          business_unit: {{ business_unit }}
          environment: {{ environment_name }}
          purpose_prefix: {{ purpose_prefix }}
        grains:
          created_at: "{{ salt.status.time(format=ISO8601) }}"
          business_unit: {{ business_unit }}
          environment: {{ environment_name }}
          {% set modified_purpose = purpose_prefix + '-' + app_type %}
          purpose: {{ modified_purpose }}
          roles:
            - edx-worker
            - edx-worker-{{ app_type }}
{% endfor %}
{% endfor %}
